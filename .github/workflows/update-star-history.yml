name: Update Star History
on:
  schedule:
    - cron: '0 8 * * *' # æ¯å¤© UTC 8ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 16:00ï¼‰æ›´æ–°
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹æŒ‰é’®è§¦å‘

permissions:
  contents: write # ğŸŸ¢ å¿…é¡»æ·»åŠ ï¼šèµ‹äºˆå†™å›ä»“åº“çš„æƒé™

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Install dependencies
        run: pip install requests matplotlib

      - name: Generate Star History Graph
        run: |
          # ğŸŸ¢ ç›´æ¥åµŒå…¥è„šæœ¬ï¼Œä¸ä¾èµ–ç¬¬ä¸‰æ–¹ä¸ç¨³å®š Action
          python -c "
          import requests
          import matplotlib.pyplot as plt
          from datetime import datetime
          import os

          repo = 'konbakuyomu/md2visio-gui'
          url = f'https://api.github.com/repos/{repo}/stargazers'
          headers = {'Accept': 'application/vnd.github.v3.star+json'}
          
          # è·å–æ‰€æœ‰ star æ•°æ®ï¼ˆæ³¨æ„ï¼šGitHub API åˆ†é¡µé»˜è®¤æ¯é¡µ30ï¼Œéœ€å¤„ç†åˆ†é¡µï¼Œæ­¤å¤„ç®€åŒ–æ¼”ç¤ºï¼Œå®é™…å»ºè®®å¾ªç¯è·å–ï¼‰
          # ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ç›´æ¥è·å–ç¬¬ä¸€é¡µï¼ˆå¦‚æœæ˜¯æ–°é¡¹ç›®å¤Ÿç”¨äº†ï¼Œå¤§é¡¹ç›®éœ€è¦å¾ªç¯ fetchï¼‰
          stars = []
          page = 1
          while True:
              r = requests.get(url + f'?per_page=100&page={page}', headers=headers)
              data = r.json()
              if not data or not isinstance(data, list): break
              stars.extend(data)
              page += 1
          
          dates = [datetime.strptime(s['starred_at'], '%Y-%m-%dT%H:%M:%SZ') for s in stars]
          dates.sort()
          
          # ç”Ÿæˆç´¯ç§¯æ•°æ®
          x = dates
          y = range(1, len(dates) + 1)
          
          plt.figure(figsize=(10, 6))
          plt.plot(x, y, marker='o', linestyle='-', color='#40c463')
          plt.title(f'Star History for {repo}')
          plt.xlabel('Date')
          plt.ylabel('Stars')
          plt.grid(True, linestyle='--', alpha=0.7)
          plt.tight_layout()
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          os.makedirs('docs', exist_ok=True)
          plt.savefig('docs/star-history.svg')
          "

      - name: Commit and Push
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add docs/star-history.svg
          # åªæœ‰æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶æ‰æäº¤ï¼Œé¿å…ç©ºæäº¤æŠ¥é”™
          git diff --quiet && git diff --staged --quiet || (git commit -m "update star history" && git push)
